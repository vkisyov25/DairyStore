<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Information</title>
    <link rel="stylesheet" href="/userInformation.css">

</head>
<body>
<div id="data-container"></div>
<div id="back-buttons"></div>
<button type="submit" id="editBtn">Редактиране</button>
<button id="saveBtn" style="display:none;" onclick="saveData()">Запази</button>
<div id="errorMessages"></div>
<script>
    console.log("Скриптът е зареден!");

    document.addEventListener("DOMContentLoaded", function () {
        console.log("Документът е зареден!");

        fetch("/user/allInformation")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Грешка: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Получени данни: ", data);
                let role = data.authorities;
                console.log("Роля:", role);
                const backButtons = document.getElementById("back-buttons");
                if (role === "seller") {
                    backButtons.innerHTML = '<a href="/test/seller">Back</a>';
                } else if (role === "buyer") {
                    backButtons.innerHTML = '<a href="/test/buyer">Back</a>';
                }

                const container = document.getElementById("data-container");
                let content = `
                        <h2>Моят профил</h2>
                        <p><strong>Име:</strong> <span>${data.name}</span></p>
                        <p><strong>Потребителско име:</strong> <span>${data.username}</span></p>
                        <p><strong>Роля:</strong> <span>${data.authorities}</span></p>
                        <p><strong>Имейл:</strong> <span>${data.email}</span></p>
                        <p><strong>Телефон:</strong> <span>${data.phone}</span></p>
                        <p><strong>Адрес:</strong> <span>${data.address}</span></p>
                    `;

                if (data.companyName && data.companyName.trim() !== "" && data.companyEIK && data.companyEIK.trim() !== "") {
                    if (role === "buyer") {
                        content += `
                            <div>
                            <p><strong>Фирма:</strong> <span>${data.companyName}</span></p>
                            <p><strong>ЕИК:</strong> <span>${data.companyEIK}</span></p>
                            <button id="deleteFirmBtn" onclick="deleteCompanyInfo()">Изтрий фирмата и нейния ЕИК</button>
                            </div>
                            <br>
                            <br>
                        `;
                    } else {
                        content += `
                            <div>
                            <p><strong>Фирма:</strong> <span>${data.companyName}</span></p>
                            <p><strong>ЕИК:</strong> <span>${data.companyEIK}</span></p>
                            </div>
                            <br>
                            <br>
                        `;
                    }

                }

                container.innerHTML = content;
            })
            .catch((error) => {
                console.error("Грешка при зареждане на данните:", error);
                document.getElementById("data-container").textContent = "Грешка при зареждане на данните.";
            });
    });

    document.getElementById("editBtn").addEventListener("click", function () {
        const container = document.getElementById("data-container");
        container.innerHTML = "";  // Изчистваме предишното съдържание

        let content = `
                 <h2>Моят профил - Редактиране</h2>
                 <label><strong>Име:</strong></label>
                 <input type="text" id="name"><br>

                 <label><strong>Имейл:</strong></label>
                 <input type="email" id="email"><br>

                 <label><strong>Телефон:</strong></label>
                 <input type="text" id="phone"><br>

                 <label><strong>Адрес:</strong></label>
                 <input type="text" id="address"><br>

                 <label><strong>Фирма:</strong></label>
                 <input type="text" id="companyName"><br>

                 <label><strong>ЕИК:</strong></label>
                 <input type="text" id="companyEIK"><br>
             `;

        container.innerHTML = content;  // Поставяме новото съдържание в контейнера

        // Скриваме бутона "Редактиране" и показваме бутона "Запази"
        document.getElementById("editBtn").style.display = "none";
        document.getElementById("saveBtn").style.display = "inline-block";
    });

    function saveData() {
        let companyName = document.getElementById("companyName") && document.getElementById("companyName").value.trim() !== ""
            ? document.getElementById("companyName").value.trim()
            : null;
        let companyEIK = document.getElementById("companyEIK") && document.getElementById("companyEIK").value.trim() !== ""
            ? document.getElementById("companyEIK").value.trim()
            : null;

        // Проверка: Ако е попълнено само едно от двете полета, показваме грешка и спираме изпращането
        if ((companyName && !companyEIK) || (!companyName && companyEIK)) {
            alert("Ако попълните 'Фирма', трябва да попълните и 'ЕИК', и обратното.");
            return;
        }
        let obj = {
            name: document.getElementById("name").value || null,
            email: document.getElementById("email").value || null,
            phone: document.getElementById("phone").value || null,
            address: document.getElementById("address").value || null,
            companyName: document.getElementById("companyName") ? document.getElementById("companyName").value : null,
            /*       companyEIK: document.getElementById("companyEIK") ? document.getElementById("companyEIK").value : null*/
            companyEIK: document.getElementById("companyEIK") && document.getElementById("companyEIK").value.trim() !== ""
                ? document.getElementById("companyEIK").value
                : null

        }

        console.log("Sending data:", obj);
        fetch("/user/edit", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(obj)
        })
            .then(response => {
                /*if (!response.ok) {
                    return response.json().then(err => {
                        throw err;
                    });
                }*/
                return response.json();
            })
            .then(result => {
                console.log("Server response:", result);
                if (result.errors) {
                    displayErrors(result.errors);
                } else {
                    alert(result.message);
                    window.location.href = "/userInformationPage.html";
                }
            })
            .catch(error => {
                console.error("Error:", error);
            })
    }

    function displayErrors(errors) {
        const errorDiv = document.getElementById("errorMessages");

        if (!errorDiv) {
            console.error("Error div not found on the page.");
            return;  // Ако няма такъв елемент, не правим нищо
        }

        errorDiv.innerHTML = "";
        // Проверка дали има грешки в масива
        if (errors && errors.length > 0) {
            errors.forEach(error => {
                console.log("Displaying error:", error);  // Лог за всяка грешка
                const p = document.createElement("p");
                p.textContent = error;
                p.style.color = "red";
                errorDiv.appendChild(p);
            });
        } else {
            console.log("No errors found to display.");
        }
    }

    function deleteCompanyInfo() {
        if (!confirm("Сигурни ли сте, че искате да изтриете фирмата и нейния ЕИК?")) {
            return; // Спира, ако потребителят натисне "Cancel"
        }

        fetch("/user/deleteCompany", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Грешка при изтриване: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log("Server response:", result);
                alert(result.message || "Фирмата беше успешно изтрита!");
                window.location.href = "/userInformationPage.html";
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Възникна грешка при изтриването.");
            });
    }

</script>
</body>
</html>
