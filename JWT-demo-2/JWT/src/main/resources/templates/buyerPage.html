<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Buyer</title>
</head>
<body>
<label th:text="${buyer}"></label>
<br>
<br>
<a th:href="@{/user/allInformation}">My profile information</a>
<br>
<a th:href="@{/products/listToBuy}">Add product in the shopping cart</a>
<br>
<a th:href="@{/cart/view}">View shopping cart and make order</a>
<br>
<button type="submit" id="viewAnalysesBtn">View analyses</button>
<br> <br>
<!-- Тук ще покажем анализа -->
<div id="analysisResult" style="display: none;">
    <h3>Buyer Analysis</h3>
    <p><strong>Total spent:</strong> <span id="totalPrice">Loading...</span></p>
    <p><strong>Average purchase price:</strong> <span id="averagePrice">Loading...</span></p>
    <p><strong>Most purchased product type:</strong> <span id="mostPurchased">Loading...</span></p>
</div>
<br>
<form action="/test/logout" method="post">
    <button type="submit">Logout</button>
</form>

<div th:if="${success}">
    <span th:text="${success}"></span>
</div>

<script>
    document.getElementById("viewAnalysesBtn").addEventListener("click", function (event) {
        event.preventDefault();

        fetch("/soldProduct/buyerAnalytics")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            /*.then(data => {
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });*/
            .then(data => {
                document.getElementById("totalPrice").textContent = data.totalPurchasePrice.toFixed(2) + " лв.";
                document.getElementById("averagePrice").textContent = data.averagePurchasePrice.toFixed(2) + " лв.";
                document.getElementById("mostPurchased").textContent = data.mostPurchasedType;

                // Показваме резултата
                document.getElementById("analysisResult").style.display = "block";
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                document.getElementById("analysisResult").innerHTML = "<p style='color: red;'>Error loading data!</p>";
                document.getElementById("analysisResult").style.display = "block";
            });
    })
</script>
</body>
</html>